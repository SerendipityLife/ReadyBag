# âœ… í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
!pip install -q googlemaps geopy ipywidgets

# âœ… ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸
import googlemaps
from geopy.geocoders import Nominatim
from IPython.display import display, HTML
import ipywidgets as widgets

# âœ… Google Maps API í‚¤ ì…ë ¥
API_KEY = 'ì—¬ê¸°ì—_ë‹¹ì‹ ì˜_API_KEYë¥¼_ì…ë ¥í•˜ì„¸ìš”'
gmaps = googlemaps.Client(key=API_KEY)

# âœ… ì‚¬ìš©ì ì…ë ¥ ìœ„ì ¯
address_input = widgets.Text(
    value='',
    placeholder='ì˜ˆ: Osaka Namba Station Hotel',
    description='ìˆ™ì†Œ ì£¼ì†Œ:',
    layout=widgets.Layout(width='80%'),
    style={'description_width': 'initial'}
)

keyword_dropdown = widgets.Dropdown(
    options=["ëˆí‚¤í˜¸í…Œ", "ì„¸ë¸ì¼ë ˆë¸", "íŒ¨ë°€ë¦¬ë§ˆíŠ¸", "ë¡œì†", "drugstore"],
    value="ëˆí‚¤í˜¸í…Œ",
    description='ì°¾ì„ ì¥ì†Œ:',
    layout=widgets.Layout(width='50%'),
    style={'description_width': 'initial'}
)

search_button = widgets.Button(description='ì¥ì†Œ ê²€ìƒ‰')
output = widgets.Output()

# âœ… ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
def on_search_click(b):
    with output:
        output.clear_output()
        address = address_input.value.strip()
        keyword = keyword_dropdown.value.strip()

        if not address:
            print("â— ìˆ™ì†Œ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            return

        # ì£¼ì†Œ â†’ ìœ„ê²½ë„
        geolocator = Nominatim(user_agent="geoapi")
        location = geolocator.geocode(address)

        if not location:
            print("â— ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            return

        lat, lng = location.latitude, location.longitude
        origin = f"{lat},{lng}"

        # ì¥ì†Œ ê²€ìƒ‰
        try:
            places_result = gmaps.places_nearby(
                location=(lat, lng),
                radius=1000,
                keyword=keyword
            )
        except Exception as e:
            print(f"â— API ì˜¤ë¥˜: {e}")
            return

        # ì¥ì†Œ ì´ë¦„ í•„í„°ë§
        keyword_lower = keyword.lower()
        filtered_places = []

        for place in places_result['results']:
            name = place['name'].lower()
            if keyword_lower == "ëˆí‚¤í˜¸í…Œ" and ("don quijote" in name or "ëˆí‚¤í˜¸í…Œ" in name):
                filtered_places.append(place)
            elif keyword_lower == "ì„¸ë¸ì¼ë ˆë¸" and ("7-eleven" in name or "ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³" in name):
                filtered_places.append(place)
            elif keyword_lower == "íŒ¨ë°€ë¦¬ë§ˆíŠ¸" and ("familymart" in name or "ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆ" in name or "family mart" in name):
                filtered_places.append(place)
            elif keyword_lower == "ë¡œì†" and ("lawson" in name or "ãƒ­ãƒ¼ã‚½ãƒ³" in name):
                filtered_places.append(place)
            elif keyword_lower == "drugstore" and ("drugstore" in name or "ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢" in name):
                filtered_places.append(place)

        if not filtered_places:
            print(f"â— ì£¼ë³€ì— '{keyword}' ê´€ë ¨ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.")
            return

        print(f"ğŸ“ ìˆ™ì†Œ ì£¼ë³€ '{keyword}' ê´€ë ¨ ì¥ì†Œ:\n")

        # ëª©ì ì§€ ë¦¬ìŠ¤íŠ¸ êµ¬ì„±
        destinations = [
            f"{p['geometry']['location']['lat']},{p['geometry']['location']['lng']}"
            for p in filtered_places
        ]

        try:
            distance_results = gmaps.distance_matrix(
                origins=[origin],
                destinations=destinations,
                mode="walking",
                language="ko"
            )
        except Exception as e:
            print(f"â— ê±°ë¦¬ ê³„ì‚° ì˜¤ë¥˜: {e}")
            return

        # ê²°ê³¼ ì¶œë ¥
        for i, (place, dist_info) in enumerate(zip(filtered_places, distance_results['rows'][0]['elements']), start=1):
            name = place['name']
            place_lat = place['geometry']['location']['lat']
            place_lng = place['geometry']['location']['lng']
            maps_url = f"https://www.google.com/maps/dir/{lat},{lng}/{place_lat},{place_lng}/"

            distance_text = dist_info['distance']['text']
            duration_text = dist_info['duration']['text']

            display(HTML(f"""
                <b>{i}. {name}</b><br>
                ğŸš¶ ê±°ë¦¬: {distance_text}, ì†Œìš” ì‹œê°„: {duration_text}<br>
                <a href="{maps_url}" target="_blank">ğŸ—º ê²½ë¡œ ë³´ê¸°</a><br><br>
            """))

# âœ… ë²„íŠ¼ ì—°ê²°
search_button.on_click(on_search_click)

# âœ… UI ì¶œë ¥
display(address_input, keyword_dropdown, search_button, output)

ìœ„ ì½”ë“œë¥¼ replitì— ë„£ê³  ì‹¶ì€ë° ì–´ë–»ê²Œ í”„ë¡¬í”„íŠ¸ë¥¼ ì£¼ë©´ ì¢‹ì„ê¹Œ?